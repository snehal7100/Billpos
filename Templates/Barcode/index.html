{% include "Component/Header.html" %}
{% include "Component/Sidebar.html" %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Print</title>
  <!-- AdminLTE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Your existing styles remain unchanged */
   
  </style>
</head>
<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Barcode Print</h3>
          <!-- Current Date and Time Display -->
          <div id="current-date-time"></div>
        </div>
        <div class="row">
          <div class="col">
            <div class="card">
              <div class="card-body">
                <div class="input-group mb-3">
                  <input type="text" id="search-bar" class="form-control" placeholder="Search" list="product-list">
                  <datalist id="product-list">
                    {% for product in productData %}
                      <option value="{{ product.pname }}" data-pid="{{ product.pid }}" data-price="{{ product.price }}">
                        {{ product.pname }} (₹{{ product.price }})
                      </option>
                    {% endfor %}
                  </datalist>
                  <!-- <button type="button" class="btn btn-primary btn-sm ms-auto" data-bs-toggle="modal" data-bs-target="#addBrandModal">
                    Add product
                  </button> -->
                  <button id="search-btn" class="btn btn-primary btn-sm ms-auto" data-bs-toggle="modal" data-bs-target="#addBrandModal"><i class="fa fa-plus"></i></button>
                </div>
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>No.</th>
                      <th>Item Name</th>
                      <th>Qty</th>
                      <th>Mrp</th>
                      <th>Sale Price</th>
                      <th>Total</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="product-table">
                    <tr id="empty-row">
                      <td colspan="7">No products available</td>
                    </tr>
                  </tbody>
                </table>

                <div class="button-container d-flex justify-content-center mb-3">
                  <button class="btn btn-primary add-button mx-2" style="margin-top: 20px;">Add</button>
                  <button class="btn btn-primary reset-button mx-2" style="margin-top: 20px;">Reset</button>
                  <button id="delete-all-btn" class="btn btn-danger mx-2" style="margin-top: 20px;">Delete All</button>
                  <!-- <button id="print-btn" class="btn btn-primary print-button mx-2">Print</button> -->
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addBrandModal" tabindex="-1" aria-labelledby="addBrandModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addBrandModalLabel">Add Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form action="/product-add/" method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
            {% csrf_token %}
            <div class="modal-body">
              <!-- Row 1: Three columns -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="pname" class="form-label">Product Name:</label>
                  <input type="text" class="form-control" id="pname" name="pname">
                </div>
                <div class="col-md-4">
                  <label for="hsncode" class="form-label">HSN Code:</label>
                  <input type="text" class="form-control" id="hsncode" name="hsncode">
                </div>
                <div class="col-md-4">
                  <label for="category" class="form-label">Category:</label>
                  <select class="form-control" id="category" name="category">
                    <option value="" disabled selected>Select category</option>
                    {% for category in categoryData %}
                    <option value="{{ category.id }}">{{ category.c_name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
          
              <!-- Row 2: Three columns -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="brand" class="form-label">Brand:</label>
                  <select class="form-control" id="brand" name="brand">
                    <option value="" disabled selected>Select Brand</option>
                    {% for brand in bData %}
                    <option value="{{ brand.id }}">{{ brand.bname }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="tax" class="form-label">Tax:</label>
                  <input type="text" class="form-control" id="tax" name="tax">
                </div>
                <div class="col-md-4">
                  <label for="taxtype" class="form-label">Tax Type:</label>
                  <select class="form-control" id="taxtype" name="taxtype">
                    <option value="" disabled selected>Select Tax Type</option>
                    {% for tax in taxData %}
                    <option value="{{ tax.id }}">{{ tax.taxname }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
          
              <!-- Row 3: Three columns -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="punit" class="form-label">Primary Unit:</label>
                  <input type="text" class="form-control" id="punit" name="punit">
                </div>
                <div class="col-md-4">
                  <label for="aunit" class="form-label">Alternate Unit:</label>
                  <input type="text" class="form-control" id="aunit" name="aunit">
                </div>
                <div class="col-md-4">
                  <label for="cfactor" class="form-label">Conversion Factor:</label>
                  <input type="text" class="form-control" id="cfactor" name="cfactor">
                </div>
              </div>
          
              <!-- Row 4: Two columns -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="price" class="form-label">Unit Price Per:</label>
                  <input type="text" class="form-control" id="price" name="price">
                </div>
              </div>
            </div>
          
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Submit</button>
            </div>
          </form>
          
        </div>
      </div>
    </div>


    

    <!-- <div class="fixed-summary-bar">
      <div>Last Bill: 5 | Amt: ₹89</div>
      <div>Total Qty: <span>11</span></div>
      <div>Total MRP: ₹500.00</div>
      <div>Total Discount: ₹-545.00</div>
      <div>Total Bill: ₹1045</div>
    </div>
  </div> -->

  <script>
    // Open modal only when the button is clicked
    document.getElementById('search-btn').addEventListener('click', function () {
      // Open the modal when the search button is clicked
      $('#productAddModal').modal('show');
    });
  
    // Handling customer selection change to display info
    document.getElementById('customer').addEventListener('change', function () {
      const selectedOption = this.options[this.selectedIndex];
      const mobileNo = selectedOption.getAttribute('data-mobile') || 'N/A';
      const address = selectedOption.getAttribute('data-address') || 'N/A';
      const creditLimit = selectedOption.getAttribute('data-credit_limit') || 'N/A';
  
      document.getElementById('mobile-no').textContent = mobileNo;
      document.getElementById('address').textContent = address;
      document.getElementById('credit_limit').textContent = creditLimit;
    });
  
    // Save cart data to localStorage
    function saveToLocalStorage() {
      const productRows = document.querySelectorAll('#product-table tr:not(#empty-row)');
      const products = Array.from(productRows).map((row) => {
        return {
          id: row.id.replace('product-', ''),
          name: row.children[1].textContent,
          quantity: parseInt(row.querySelector('.quantity').textContent, 10),
          price: parseFloat(row.children[3].textContent.replace('₹', '')),
        };
      });
      localStorage.setItem('products', JSON.stringify(products));
      calculateTotals();  // Recalculate totals when saving
    }
  
    // Load cart data from localStorage
    function loadFromLocalStorage() {
      const productData = JSON.parse(localStorage.getItem('products')) || [];
      const productTable = document.getElementById('product-table');
      const emptyRow = document.getElementById('empty-row');
  
      if (productData.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.id = 'empty-row';
        emptyRow.innerHTML = `<td colspan="7">No products available</td>`;
        productTable.appendChild(emptyRow);
      }
  
      productData.forEach((product, index) => {
        const row = document.createElement('tr');
        row.id = `product-${product.id}`;
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${product.name}</td>
          <td>
            <div class="btn-group">
              <button class="btn btn-sm btn-secondary decrement">-</button>
              <span class="quantity">${product.quantity}</span>
              <button class="btn btn-sm btn-secondary increment">+</button>
            </div>
          </td>
          <td>₹${product.price.toFixed(2)}</td>
          <td>₹${product.price.toFixed(2)}</td>
          <td>₹${(product.quantity * product.price).toFixed(2)}</td>
          <td>
            <button class="btn btn-sm btn-danger remove">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        productTable.appendChild(row);
  
        row.querySelector('.increment').addEventListener('click', () => updateQuantity(row, 1));
        row.querySelector('.decrement').addEventListener('click', () => updateQuantity(row, -1));
        row.querySelector('.remove').addEventListener('click', () => {
          const confirmDelete = confirm("Are you sure you want to delete this product?");
          if (confirmDelete) {
            row.remove();
            saveToLocalStorage();
            calculateTotals();
          }
        });
  
        if (emptyRow) emptyRow.remove();
      });
  
      calculateTotals();  // Recalculate totals after loading
    }
  
    // Calculate the total amount for the products
    function calculateTotals() {
      const productRows = document.querySelectorAll('#product-table tr:not(#empty-row)');
      let total = 0;
  
      productRows.forEach((row) => {
        const totalCell = row.children[5];
        if (totalCell) {
          total += parseFloat(totalCell.textContent.replace('₹', '')) || 0;
        }
      });
  
      document.querySelector('.total-amount').textContent = `₹${total.toFixed(2)}`;
      document.querySelectorAll('.fixed-summary-bar div')[4].textContent = `Total Bill: ₹${total.toFixed(2)}`;
      document.getElementById('bill-total').textContent = total.toFixed(2);
  
      localStorage.setItem('total', total.toFixed(2));
    }
<<<<<<< HEAD

    // Event listener for adding products to the table
    document.getElementById('search-btn').addEventListener('click', function () {
      const searchBar = document.getElementById('search-bar');
      const query = searchBar.value.toLowerCase().trim();
      const productOption = Array.from(document.querySelectorAll('#product-list option')).find(
        (option) => option.value.toLowerCase() === query
      );

      if (productOption) {
        const pid = productOption.getAttribute('data-pid');
        const pname = productOption.value;
        const price = parseFloat(productOption.getAttribute('data-price'));
        const productTable = document.getElementById('product-table');

        let existingRow = Array.from(productTable.children).find(
          (row) => row.id === `product-${pid}` && row.querySelector('td:nth-child(2)').textContent === pname
        );

        if (existingRow) {
          const quantityInput = existingRow.querySelector('.quantity');
          quantityInput.value = parseInt(quantityInput.value, 10) + 1;
          updateTotal(existingRow);
        } else {
          const currentRowCount = productTable.querySelectorAll('tr').length;
          let row = document.createElement('tr');
          row.id = `product-${pid}`;
          row.innerHTML = `
            <td>${currentRowCount}</td>
            <td>${pname}</td>
            <td><input type="number" class="form-control quantity" value="1" min="1"></td>
            <td>₹${price.toFixed(2)}</td>
            <td>₹${price.toFixed(2)}</td>
            <td>₹${price.toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-danger remove">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          productTable.appendChild(row);

          // Add event listener for quantity change
          row.querySelector('.quantity').addEventListener('input', function () {
            updateTotal(row);
            saveToLocalStorage();
            calculateTotals();
          });

          row.querySelector('.remove').addEventListener('click', () => {
            row.remove();
            saveToLocalStorage();
            calculateTotals();
          });
        }

        saveToLocalStorage();
        calculateTotals();
      } else {
        
      }

      searchBar.value = ''; // Clear the search bar
    });

    // Load data from localStorage when the page loads
    document.addEventListener('DOMContentLoaded', loadFromLocalStorage);

    // Event listener for 'Enter' key
   // Event listener for 'Enter' key
document.getElementById('search-bar').addEventListener('keydown', function (event) {
  if (event.key === 'Enter') {
    event.preventDefault(); // Prevent the default form submission
    document.getElementById('search-btn').click(); // Trigger the search button click
  }
});

    // Event listener for "Delete All" button
document.getElementById('delete-all-btn').addEventListener('click', function () {
  const confirmDeleteAll = confirm("Are you sure you want to delete all products?");
  if (confirmDeleteAll) {
    const productTable = document.getElementById('product-table');
    productTable.innerHTML = '<tr id="empty-row"><td colspan="7">No products available</td></tr>';
    localStorage.removeItem('products');
    localStorage.removeItem('total');
    calculateTotals(); // Recalculate totals to update the UI
  }
});

// document.getElementById('search-btn').addEventListener('click', function () {
//     window.location.href = 'addproduct'; // Change 'addproduct' to the actual URL or route if necessary
//   });
=======
  
    // Handling the search bar and adding products to the table
    document.getElementById('search-bar').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent default action
  
        const searchBar = document.getElementById('search-bar');
        const query = searchBar.value.toLowerCase().trim();
        const productOption = Array.from(document.querySelectorAll('#product-list option')).find(
          (option) => option.value.toLowerCase() === query
        );
  
        if (productOption) {
          const pid = productOption.getAttribute('data-pid');
          const pname = productOption.value;
          const price = parseFloat(productOption.getAttribute('data-price'));
          const productTable = document.getElementById('product-table');
  
          let existingRow = Array.from(productTable.children).find(
            (row) => row.id === `product-${pid}` && row.querySelector('td:nth-child(2)').textContent === pname
          );
  
          if (existingRow) {
            updateQuantity(existingRow, 1);
          } else {
            const currentRowCount = productTable.querySelectorAll('tr').length;
            let row = document.createElement('tr');
            row.id = `product-${pid}`;
            row.innerHTML = `
              <td>${currentRowCount}</td>
              <td>${pname}</td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-secondary decrement">-</button>
                  <span class="quantity">1</span>
                  <button class="btn btn-sm btn-secondary increment">+</button>
                </div>
              </td>
              <td>₹${price.toFixed(2)}</td>
              <td>₹${price.toFixed(2)}</td>
              <td>₹${price.toFixed(2)}</td>
              <td>
                <button class="btn btn-sm btn-danger remove">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            `;
            productTable.appendChild(row);
  
            row.querySelector('.increment').addEventListener('click', () => updateQuantity(row, 1));
            row.querySelector('.decrement').addEventListener('click', () => updateQuantity(row, -1));
            row.querySelector('.remove').addEventListener('click', () => {
              row.remove();
              saveToLocalStorage();
              calculateTotals();
            });
          }
  
          saveToLocalStorage();
          calculateTotals();
        } else {
          alert('Product not found!');
        }
  
        searchBar.value = ''; // Clear the search bar after the action
      }
    });
  
    // Update the quantity of products in the cart
    function updateQuantity(row, delta) {
      const quantitySpan = row.querySelector('.quantity');
      let quantity = parseInt(quantitySpan.textContent, 10);
      quantity = Math.max(1, quantity + delta);
      quantitySpan.textContent = quantity;
  
      const price = parseFloat(row.children[3].textContent.replace('₹', ''));
      row.children[5].textContent = `₹${(quantity * price).toFixed(2)}`;
  
      saveToLocalStorage();
      calculateTotals();
    }
  
    // Save bill and print receipt
    document.getElementById('save-bill-btn').addEventListener('click', function () {
      // Collect customer data and product list
      const customerSelect = document.getElementById('customer');
      const customerName = customerSelect.options[customerSelect.selectedIndex].text;
      const customerAddress = customerSelect.options[customerSelect.selectedIndex].getAttribute('data-address') || 'N/A';
  
      const paymentTermSelect = document.getElementById('payment-term');
      const paymentTermText = paymentTermSelect.options[paymentTermSelect.selectedIndex].text;
  
      const productRows = document.querySelectorAll('#product-table tr:not(#empty-row)');
      const products = Array.from(productRows).map(row => ({
        name: row.children[1].textContent,
        quantity: row.querySelector('.quantity').textContent,
        price: row.children[3].textContent,
        total: row.children[5].textContent
      }));
  
      let totalAmount = 0;
      products.forEach(product => {
        totalAmount += parseFloat(product.total.replace('₹', ''));
      });
  
      const printContent = `
        <h3>Bill Receipt</h3>
        <p><strong>Customer:</strong> ${customerName}</p>
        <p><strong>Address:</strong> ${customerAddress}</p>
        <p><strong>Payment Term:</strong> ${paymentTermText}</p>
        <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th>No.</th>
              <th>Item Name</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${products.map((product, index) => `
              <tr>
                <td>${index + 1}</td>
                <td>${product.name}</td>
                <td>${product.quantity}</td>
                <td>${product.price}</td>
                <td>${product.total}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <p><strong>Total Amount:</strong> ₹${totalAmount.toFixed(2)}</p>
      `;
  
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Bill Receipt</title></head><body>');
      printWindow.document.write(printContent);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    });
  
    // Delete all products and reset
    document.getElementById('delete-all-btn').addEventListener('click', function () {
      const confirmDeleteAll = confirm("Are you sure you want to delete all products?");
      if (confirmDeleteAll) {
        const productTable = document.getElementById('product-table');
        productTable.innerHTML = ''; // Remove all rows
        localStorage.removeItem('products'); // Clear products from localStorage
        calculateTotals(); // Update totals
  
        // Add the empty row back
        const emptyRow = document.createElement('tr');
        emptyRow.id = 'empty-row';
        emptyRow.innerHTML = `<td colspan="7">No products available</td>`;
        productTable.appendChild(emptyRow);
      }
    });
  
    // Load the cart from localStorage when the page loads
    window.onload = function() {
      loadFromLocalStorage();
    };
>>>>>>> c83b3591d6e4c9065ebd3876bc7b8b8bc5812a8c
  </script>
  <!-- AdminLTE JS -->
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% include "Component/Footer.html" %}
